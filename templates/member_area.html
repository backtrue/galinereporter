
{% extends "base.html" %}

{% block title %}æœƒå“¡å°ˆå€ - å ±æ•¸æ“š{% endblock %}

{% block content %}
<h1>æœƒå“¡å°ˆå€</h1>

<div class="section member-info">
    <h2>ğŸ‘¤ æœƒå“¡è³‡è¨Š</h2>
    {% if config %}
        <div class="member-info-grid">
            <div class="info-item">
                <label>æœƒå“¡ç­‰ç´šï¼š</label>
                <span class="membership-badge {% if config.membership_type == 'pro' %}pro-member{% else %}free-member{% endif %}">
                    {{ config.membership_type|default('free')|upper }}
                </span>
            </div>
            <div class="info-item">
                <label>å‰©é¤˜ Creditsï¼š</label>
                <span class="credits-count">{{ config.credits }}</span>
            </div>
            <div class="info-item">
                <label>æˆ‘çš„æ¨è–¦ç¢¼ï¼š</label>
                <span class="referral-code">{{ referral_code or 'å°šæœªç”¢ç”Ÿ' }}</span>
            </div>
            <div class="info-item">
                <label>æœƒå“¡ä¿¡ç®±ï¼š</label>
                <span class="member-email">{{ config.google_email }}</span>
            </div>
            <div class="info-item">
                <label>è¨»å†Šæ™‚é–“ï¼š</label>
                <span class="join-date">{{ config.updated_at.strftime('%Yå¹´%mæœˆ%dæ—¥') if config.updated_at else 'æœªçŸ¥' }}</span>
            </div>
        </div>
        
        {% if config.membership_type == 'free' %}
        <div class="upgrade-prompt">
            <h3>å‡ç´šåˆ° PRO æœƒå“¡</h3>
            <p>äº«å—æ›´å¤šåŠŸèƒ½å’Œæ¯æœˆ 150 é»æ•¸è£œå……ï¼</p>
            <button class="button button-primary" onclick="upgradeSubscription()">ç«‹å³å‡ç´š</button>
        </div>
        {% endif %}
    {% else %}
        <p class="status-warning">å°šæœªç™»å…¥ï¼Œç„¡æ³•å–å¾—æœƒå“¡è³‡è¨Šã€‚</p>
    {% endif %}
</div>

<div class="section credit-logs">
    <h3>ğŸ’° æœ€è¿‘ 10 ç­†é»æ•¸ç•°å‹•ç´€éŒ„</h3>
    {% if credits_logs and credits_logs|length > 0 %}
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>æ™‚é–“</th>
                        <th>ç•°å‹•</th>
                        <th>ä¾†æº/ç”¨é€”</th>
                        <th>é¤˜é¡</th>
                        <th>èªªæ˜</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in credits_logs %}
                    <tr>
                        <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            {% if log.delta > 0 %}
                                <span class="credit-increase">+{{ log.delta }}</span>
                            {% else %}
                                <span class="credit-decrease">{{ log.delta }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="change-type">{{ log.change_type }}</span>
                        </td>
                        <td>{{ log.balance }}</td>
                        <td>{{ log.description or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="empty-state">
            <p>å°šç„¡é»æ•¸ç•°å‹•ç´€éŒ„</p>
        </div>
    {% endif %}
</div>

<div class="section referral-logs">
    <h3>ğŸ æœ€è¿‘ 10 ç­†æ¨è–¦çå‹µç´€éŒ„</h3>
    {% if referral_logs and referral_logs|length > 0 %}
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>æ™‚é–“</th>
                        <th>è¢«æ¨è–¦äºº Email</th>
                        <th>çå‹µé»æ•¸</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in referral_logs %}
                    <tr>
                        <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{{ log.referred_email }}</td>
                        <td>
                            <span class="credit-increase">+{{ log.credits_awarded }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="empty-state">
            <p>å°šç„¡æ¨è–¦ç´€éŒ„</p>
        </div>
    {% endif %}
</div>

<div class="section referral-program">
    <h3>ğŸ“¢ æ¨è–¦è¨ˆç•«</h3>
    <div class="referral-info">
        <p>åˆ†äº«æ‚¨çš„æ¨è–¦ç¢¼ï¼Œæ¯æˆåŠŸæ¨è–¦ä¸€ä½æ–°æœƒå“¡è¨»å†Šï¼Œæ‚¨å°‡ç²å¾— <strong>{{ REFERRAL_AWARD_CREDITS or 20 }} é»æ•¸</strong>ï¼</p>
        {% if referral_code %}
        <div class="referral-share">
            <label>æ‚¨çš„æ¨è–¦ç¢¼ï¼š</label>
            <div class="referral-code-box">
                <span id="referralCode">{{ referral_code }}</span>
                <button onclick="copyReferralCode()" class="button button-small">è¤‡è£½</button>
            </div>
            <p class="referral-link">
                æ¨è–¦é€£çµï¼š<span id="referralLink">{{ request.url_root }}?ref={{ referral_code }}</span>
                <button onclick="copyReferralLink()" class="button button-small">è¤‡è£½é€£çµ</button>
            </p>
        </div>
        {% endif %}
    </div>
</div>

<div class="section navigation">
    <a href="{{ url_for('index') }}" class="button">è¿”å›å„€è¡¨æ¿</a>
</div>

<script>
function copyReferralCode() {
    const code = document.getElementById('referralCode').textContent;
    navigator.clipboard.writeText(code).then(() => {
        alert('æ¨è–¦ç¢¼å·²è¤‡è£½ï¼');
    });
}

function copyReferralLink() {
    const link = document.getElementById('referralLink').textContent;
    navigator.clipboard.writeText(link).then(() => {
        alert('æ¨è–¦é€£çµå·²è¤‡è£½ï¼');
    });
}

async function upgradeSubscription() {
    try {
        const response = await fetch('/api/stripe/create-checkout-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: '{{ config.google_email if config else "" }}',
                success_url: window.location.origin + '/member-area?upgrade=success',
                cancel_url: window.location.origin + '/member-area?upgrade=cancel'
            })
        });
        
        const data = await response.json();
        if (data.checkout_url) {
            window.location.href = data.checkout_url;
        } else {
            alert('å‡ç´šå¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
    } catch (error) {
        alert('å‡ç´šå¤±æ•—ï¼š' + error.message);
    }
}
</script>
{% endblock %}

{% block head_extra %}
<style>
.member-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.info-item {
    background: var(--neutral-background, #f8f9fa);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid var(--border-color, #e9ecef);
}

.info-item label {
    display: block;
    font-weight: bold;
    color: var(--text-secondary, #666);
    margin-bottom: 5px;
    font-size: 0.9em;
}

.membership-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.85em;
}

.pro-member {
    background: linear-gradient(45deg, #ffd700, #ffed4e);
    color: #8b7200;
}

.free-member {
    background: var(--neutral-background, #e9ecef);
    color: var(--text-secondary, #666);
}

.credits-count {
    font-size: 1.2em;
    font-weight: bold;
    color: var(--primary-sky-blue, #0891b2);
}

.referral-code {
    font-family: 'Courier New', monospace;
    background: var(--background-color, #fff);
    padding: 4px 8px;
    border: 1px solid var(--border-color, #ddd);
    border-radius: 4px;
}

.table-container {
    overflow-x: auto;
    margin: 15px 0;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--background-color, #fff);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.data-table th {
    background: var(--primary-sky-blue, #0891b2);
    color: white;
    padding: 12px;
    text-align: left;
    font-weight: bold;
}

.data-table td {
    padding: 12px;
    border-bottom: 1px solid var(--border-color, #e9ecef);
}

.data-table tbody tr:hover {
    background: var(--neutral-background, #f8f9fa);
}

.credit-increase {
    color: #28a745;
    font-weight: bold;
}

.credit-decrease {
    color: #dc3545;
    font-weight: bold;
}

.change-type {
    background: var(--neutral-background, #e9ecef);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.85em;
}

.empty-state {
    text-align: center;
    padding: 40px;
    color: var(--text-secondary, #666);
    background: var(--neutral-background, #f8f9fa);
    border-radius: 8px;
}

.upgrade-prompt {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    margin: 20px 0;
    text-align: center;
}

.upgrade-prompt h3 {
    margin: 0 0 10px 0;
}

.upgrade-prompt p {
    margin: 0 0 15px 0;
    opacity: 0.9;
}

.referral-info {
    background: var(--neutral-background, #f8f9fa);
    padding: 20px;
    border-radius: 8px;
    border: 1px solid var(--border-color, #e9ecef);
}

.referral-share {
    margin-top: 15px;
}

.referral-code-box {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0;
}

.referral-code-box span {
    background: var(--background-color, #fff);
    border: 1px solid var(--border-color, #ddd);
    padding: 8px 12px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-weight: bold;
}

.referral-link {
    margin: 10px 0;
    font-size: 0.9em;
}

.referral-link span {
    display: inline-block;
    background: var(--background-color, #fff);
    border: 1px solid var(--border-color, #ddd);
    padding: 4px 8px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.8em;
    margin: 0 5px;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
</style>
{% endblock %}
